<?xml version="1.0"?>
<!--
/**
 * Jscriptz SmartShipping - Dependency Injection Configuration
 *
 * Registers carriers: USPS, UPS, FedEx
 * Provides: TransitTimeRepository, loggers per carrier
 */
-->
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">

    <!-- API Interface Preferences -->
    <preference for="Jscriptz\SmartShipping\Api\TransitTimeRepositoryInterface"
                type="Jscriptz\SmartShipping\Model\TransitTimeRepository"/>
    <preference for="Jscriptz\SmartShipping\Api\TransitTimeManagementInterface"
                type="Jscriptz\SmartShipping\Model\TransitTimeManagement"/>
    <preference for="Jscriptz\SmartShipping\Api\Data\TransitTimeInterface"
                type="Jscriptz\SmartShipping\Model\TransitTime"/>

    <!-- Webhook Tracking Interfaces -->
    <preference for="Jscriptz\SmartShipping\Api\Data\TrackingEventInterface"
                type="Jscriptz\SmartShipping\Model\TrackingEvent"/>
    <preference for="Jscriptz\SmartShipping\Api\TrackingEventRepositoryInterface"
                type="Jscriptz\SmartShipping\Model\TrackingEventRepository"/>
    <preference for="Jscriptz\SmartShipping\Api\Data\WebhookSubscriptionInterface"
                type="Jscriptz\SmartShipping\Model\WebhookSubscription"/>
    <preference for="Jscriptz\SmartShipping\Api\WebhookSubscriptionRepositoryInterface"
                type="Jscriptz\SmartShipping\Model\WebhookSubscriptionRepository"/>

    <!-- Shipment Service Interfaces -->
    <preference for="Jscriptz\SmartShipping\Api\ShipmentServiceInterface"
                type="Jscriptz\SmartShipping\Model\Shipment\ShipmentService"/>
    <preference for="Jscriptz\SmartShipping\Api\LabelProviderInterface"
                type="Jscriptz\SmartShipping\Model\Usps\LabelProvider"/>
    <preference for="Jscriptz\SmartShipping\Api\Data\ShipmentLabelInterface"
                type="Jscriptz\SmartShipping\Model\Shipment\ShipmentLabel"/>
    <preference for="Jscriptz\SmartShipping\Api\Data\ShipmentResultInterface"
                type="Jscriptz\SmartShipping\Model\Shipment\ShipmentResult"/>

    <!-- ═══════════════════════════════════════════════════════════════════════
         USPS Carrier Configuration
         ═══════════════════════════════════════════════════════════════════════ -->

    <!-- USPS Virtual Logger -->
    <virtualType name="Jscriptz\SmartShipping\Model\Usps\Logger" type="Magento\Framework\Logger\Monolog">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="debug" xsi:type="object">Jscriptz\SmartShipping\Model\Usps\Logger\Handler</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="Jscriptz\SmartShipping\Model\Usps\Logger\Handler" type="Magento\Framework\Logger\Handler\Base">
        <arguments>
            <argument name="fileName" xsi:type="string">/var/log/uspsv3.log</argument>
        </arguments>
    </virtualType>

    <!-- USPS Carrier -->
    <type name="Jscriptz\SmartShipping\Model\Usps\Carrier">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Usps\Logger</argument>
        </arguments>
    </type>

    <!-- USPS Clients -->
    <type name="Jscriptz\SmartShipping\Model\Usps\Client\AuthClient">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Usps\Logger</argument>
        </arguments>
    </type>

    <type name="Jscriptz\SmartShipping\Model\Usps\Client\ShippingOptionsClient">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Usps\Logger</argument>
        </arguments>
    </type>

    <!-- USPS Cache -->
    <type name="Jscriptz\SmartShipping\Model\Usps\Cache\RateCache">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Usps\Logger</argument>
        </arguments>
    </type>

    <!-- USPS Response Parser -->
    <type name="Jscriptz\SmartShipping\Model\Usps\Response\ShippingOptionsResponseParser">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Usps\Logger</argument>
        </arguments>
    </type>

    <!-- ═══════════════════════════════════════════════════════════════════════
         UPS Carrier Configuration
         ═══════════════════════════════════════════════════════════════════════ -->

    <!-- UPS Virtual Logger -->
    <virtualType name="Jscriptz\SmartShipping\Model\Ups\Logger" type="Magento\Framework\Logger\Monolog">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="debug" xsi:type="object">Jscriptz\SmartShipping\Model\Ups\Logger\Handler</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="Jscriptz\SmartShipping\Model\Ups\Logger\Handler" type="Magento\Framework\Logger\Handler\Base">
        <arguments>
            <argument name="fileName" xsi:type="string">/var/log/upsv3.log</argument>
        </arguments>
    </virtualType>

    <!-- UPS Carrier -->
    <type name="Jscriptz\SmartShipping\Model\Ups\Carrier">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Ups\Logger</argument>
        </arguments>
    </type>

    <!-- UPS Clients -->
    <type name="Jscriptz\SmartShipping\Model\Ups\Client\AuthClient">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Ups\Logger</argument>
        </arguments>
    </type>

    <type name="Jscriptz\SmartShipping\Model\Ups\Client\RatingClient">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Ups\Logger</argument>
        </arguments>
    </type>

    <type name="Jscriptz\SmartShipping\Model\Ups\Client\TransitClient">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Ups\Logger</argument>
        </arguments>
    </type>

    <!-- UPS Cache -->
    <type name="Jscriptz\SmartShipping\Model\Ups\Cache\RateCache">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Ups\Logger</argument>
        </arguments>
    </type>

    <!-- UPS Response Parser -->
    <type name="Jscriptz\SmartShipping\Model\Ups\Response\RateResponseParser">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Ups\Logger</argument>
        </arguments>
    </type>

    <!-- UPS Label Client -->
    <type name="Jscriptz\SmartShipping\Model\Ups\Client\LabelClient">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Ups\Logger</argument>
        </arguments>
    </type>

    <!-- UPS Label Provider -->
    <type name="Jscriptz\SmartShipping\Model\Ups\LabelProvider">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Ups\Logger</argument>
        </arguments>
    </type>

    <!-- ═══════════════════════════════════════════════════════════════════════
         FedEx Carrier Configuration
         ═══════════════════════════════════════════════════════════════════════ -->

    <!-- FedEx Virtual Logger -->
    <virtualType name="Jscriptz\SmartShipping\Model\Fedex\Logger" type="Magento\Framework\Logger\Monolog">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="debug" xsi:type="object">Jscriptz\SmartShipping\Model\Fedex\Logger\Handler</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="Jscriptz\SmartShipping\Model\Fedex\Logger\Handler" type="Magento\Framework\Logger\Handler\Base">
        <arguments>
            <argument name="fileName" xsi:type="string">/var/log/fedexv3.log</argument>
        </arguments>
    </virtualType>

    <!-- FedEx Carrier -->
    <type name="Jscriptz\SmartShipping\Model\Fedex\Carrier">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Fedex\Logger</argument>
        </arguments>
    </type>

    <!-- FedEx Clients -->
    <type name="Jscriptz\SmartShipping\Model\Fedex\Client\AuthClient">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Fedex\Logger</argument>
        </arguments>
    </type>

    <type name="Jscriptz\SmartShipping\Model\Fedex\Client\RatingClient">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Fedex\Logger</argument>
        </arguments>
    </type>

    <!-- FedEx Cache -->
    <type name="Jscriptz\SmartShipping\Model\Fedex\Cache\RateCache">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Fedex\Logger</argument>
        </arguments>
    </type>

    <!-- FedEx Response Parser -->
    <type name="Jscriptz\SmartShipping\Model\Fedex\Response\RateResponseParser">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Fedex\Logger</argument>
        </arguments>
    </type>

    <!-- FedEx Label Client -->
    <type name="Jscriptz\SmartShipping\Model\Fedex\Client\LabelClient">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Fedex\Logger</argument>
        </arguments>
    </type>

    <!-- FedEx Label Provider -->
    <type name="Jscriptz\SmartShipping\Model\Fedex\LabelProvider">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Fedex\Logger</argument>
        </arguments>
    </type>

    <!-- ═══════════════════════════════════════════════════════════════════════
         Shipment Automation Configuration
         ═══════════════════════════════════════════════════════════════════════ -->

    <!-- SmartShipping Virtual Logger -->
    <virtualType name="Jscriptz\SmartShipping\Model\Shipment\Logger" type="Magento\Framework\Logger\Monolog">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="debug" xsi:type="object">Jscriptz\SmartShipping\Model\Shipment\Logger\Handler</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="Jscriptz\SmartShipping\Model\Shipment\Logger\Handler" type="Magento\Framework\Logger\Handler\Base">
        <arguments>
            <argument name="fileName" xsi:type="string">/var/log/smartshipping.log</argument>
        </arguments>
    </virtualType>

    <!-- Label Provider Pool -->
    <type name="Jscriptz\SmartShipping\Model\Shipment\LabelProviderPool">
        <arguments>
            <argument name="providers" xsi:type="array">
                <item name="uspsv3" xsi:type="object">Jscriptz\SmartShipping\Model\Usps\LabelProvider</item>
                <item name="upsv3" xsi:type="object">Jscriptz\SmartShipping\Model\Ups\LabelProvider</item>
                <item name="fedexv3" xsi:type="object">Jscriptz\SmartShipping\Model\Fedex\LabelProvider</item>
            </argument>
        </arguments>
    </type>

    <!-- Shipment Service -->
    <type name="Jscriptz\SmartShipping\Model\Shipment\ShipmentService">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Shipment\Logger</argument>
        </arguments>
    </type>

    <!-- USPS Label Clients -->
    <type name="Jscriptz\SmartShipping\Model\Usps\Client\PaymentClient">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Usps\Logger</argument>
        </arguments>
    </type>

    <type name="Jscriptz\SmartShipping\Model\Usps\Client\LabelClient">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Usps\Logger</argument>
        </arguments>
    </type>

    <type name="Jscriptz\SmartShipping\Model\Usps\Client\TrackingClient">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Usps\Logger</argument>
        </arguments>
    </type>

    <!-- USPS Label Provider -->
    <type name="Jscriptz\SmartShipping\Model\Usps\LabelProvider">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Usps\Logger</argument>
        </arguments>
    </type>

    <!-- Auto-Ship Observers -->
    <type name="Jscriptz\SmartShipping\Observer\AutoShipOnOrderPlace">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Shipment\Logger</argument>
        </arguments>
    </type>

    <type name="Jscriptz\SmartShipping\Observer\AutoShipOnInvoice">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Shipment\Logger</argument>
        </arguments>
    </type>

    <!-- ═══════════════════════════════════════════════════════════════════════
         Admin Plugins
         ═══════════════════════════════════════════════════════════════════════ -->

    <!-- Add "Create Shipping Label" button to order view page -->
    <type name="Magento\Backend\Block\Widget\Button\Toolbar">
        <plugin name="smartshipping_add_label_button"
                type="Jscriptz\SmartShipping\Plugin\Adminhtml\AddLabelButtonToOrderView"/>
    </type>

    <!-- ═══════════════════════════════════════════════════════════════════════
         Webhook Tracking Configuration
         ═══════════════════════════════════════════════════════════════════════ -->

    <!-- Webhook Virtual Logger -->
    <virtualType name="Jscriptz\SmartShipping\Model\Webhook\Logger" type="Magento\Framework\Logger\Monolog">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="debug" xsi:type="object">Jscriptz\SmartShipping\Model\Webhook\Logger\Handler</item>
            </argument>
        </arguments>
    </virtualType>

    <virtualType name="Jscriptz\SmartShipping\Model\Webhook\Logger\Handler" type="Magento\Framework\Logger\Handler\Base">
        <arguments>
            <argument name="fileName" xsi:type="string">/var/log/smartshipping_webhook.log</argument>
        </arguments>
    </virtualType>

    <!-- Webhook Processor Pool (carriers will inject their processors here) -->
    <type name="Jscriptz\SmartShipping\Model\Webhook\ProcessorPool">
        <arguments>
            <argument name="processors" xsi:type="array">
                <!-- Carrier processors will be added by each carrier module -->
            </argument>
        </arguments>
    </type>

    <!-- Webhook Controller -->
    <type name="Jscriptz\SmartShipping\Controller\Webhook\Receive">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Webhook\Logger</argument>
        </arguments>
    </type>

    <!-- Notification Service -->
    <type name="Jscriptz\SmartShipping\Model\Webhook\NotificationService">
        <arguments>
            <argument name="logger" xsi:type="object">Jscriptz\SmartShipping\Model\Webhook\Logger</argument>
        </arguments>
    </type>

</config>
